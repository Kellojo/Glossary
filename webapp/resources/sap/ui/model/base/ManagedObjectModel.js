/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','../json/JSONModel','../json/JSONPropertyBinding','../json/JSONListBinding','sap/ui/base/ManagedObject','sap/ui/base/ManagedObjectObserver','../Context','../ChangeReason'],function(q,J,a,b,M,c,C,d){"use strict";var e=b.extend("sap.ui.model.base.ManagedObjectModelAggregationBinding"),f=a.extend("sap.ui.model.base.ManagedObjectModelPropertyBinding"),g="@custom",I="--";var h=J.extend("sap.ui.model.base.ManagedObjectModel",{constructor:function(o,D){if(!D&&typeof D!="object"){D={};}D[g]={};this._oObject=o;this._mObservedCount={properties:{},aggregations:{}};J.apply(this,[D]);this._oObserver=new c(this.observerChanges.bind(this));}});h.prototype.getAggregation=J.prototype.getProperty;h.prototype.setData=function(D,m){var _={};_[g]=D;J.prototype.setData.apply(this,[_,m]);};h.prototype.getJSON=function(){return JSON.stringify(this.oData[g]);};h.prototype.setProperty=function(p,v,o,A){var r=this.resolve(p,o),l,O,P;if(!r){return false;}if(r.indexOf("/"+g)===0){return J.prototype.setProperty.apply(this,arguments);}l=r.lastIndexOf("/");O=r.substring(0,l||1);P=r.substr(l+1);var i=this._getObject(O);if(i){if(i instanceof M){var j=i.getMetadata().getProperty(P);if(j){var s=j._sMutator,G=j._sGetter;if(i[G]()!==v){i[s](v);this.checkUpdate(false,A);return true;}}}else if(i[P]!==v){i[P]=v;this.checkUpdate(false,A);return true;}}return false;};h.prototype.addBinding=function(B){J.prototype.addBinding.apply(this,arguments);this.checkUpdate();};h.prototype.removeBinding=function(B){J.prototype.removeBinding.apply(this,arguments);if(B._bAttached){B._bAttached=false;this._getObject(B.getPath(),B.getContext(),false);}};h.prototype.firePropertyChange=function(A){if(A.reason===d.Binding){A.resolvedPath=this.resolve(A.path,A.context);}J.prototype.firePropertyChange.call(this,A);};h.prototype.bindAggregation=function(p,o,P){return J.prototype.bindProperty.apply(this,arguments);};h.prototype.bindProperty=function(p,o,P){var B=new f(this,p,o,P);return B;};h.prototype.bindList=function(p,o,s,F,P){var B=new e(this,p,o,s,F,P);B.enableExtendedChangeDetection();return B;};h.prototype.getManagedObject=function(p,o){if(p instanceof C){o=p;p=o.getPath();}var O=this.getProperty(p,o);if(O instanceof M){return O;}return null;};h.prototype.getRootObject=function(){return this._oObject;};h.prototype._observePropertyChange=function(o,p){if(!o||!p){return;}var k=o.getId()+"/@"+p.name;if(!this._oObserver.isObserved(o,{properties:[p.name]})){this._oObserver.observe(o,{properties:[p.name]});this._mObservedCount.properties[k]=1;}else{this._mObservedCount.properties[k]++;}};h.prototype._unobservePropertyChange=function(o,p){if(!o||!p){return;}var k=o.getId()+"/@"+p.name;this._mObservedCount.properties[k]--;if(this._mObservedCount.properties[k]==0){this._oObserver.unobserve(o,{properties:[p.name]});delete this._mObservedCount.properties[k];}};h.prototype._observeAggregationChange=function(o,A){if(!o||!A){return;}var k=o.getId()+"/@"+A.name;if(!this._oObserver.isObserved(o,{aggregations:[A.name]})){this._oObserver.observe(o,{aggregations:[A.name]});this._mObservedCount.aggregations[k]=1;}else{this._mObservedCount.aggregations[k]++;}};h.prototype._unobserveAggregationChange=function(o,A){if(!o||!A){return;}var k=o.getId()+"/@"+A.name;this._mObservedCount.aggregations[k]--;if(this._mObservedCount.aggregations[k]==0){this._oObserver.unobserve(o,{aggregations:[A.name]});delete this._mObservedCount.aggregations[k];}};h.prototype._createId=function(i){var o=this._oObject;if(typeof o.createId==="function"){return o.createId(i);}if(!i){return o.getId()+I+q.sap.uid();}if(i.indexOf(o.getId()+I)!=0){return o.getId()+I+i;}return i;};h.prototype._getSpecialNode=function(n,s,p,P){if(n instanceof M){if(s==="className"){if(n.getMetadata){return n.getMetadata().getName();}else{return typeof n;}}else if(s==="id"){return n.getId();}else if(s==="metadataContexts"){return n._oProviderData;}}else if(s==="binding"&&p&&P){return p.getBinding(P);}else if(s==="bound"&&p&&P){return p.isBound(P);}else if(s==="bindingInfo"&&p&&P){return p.getBindingInfo(P);}else if(q.isArray(n)){if(s==="length"){return n.length;}else if(s.indexOf("id=")===0){var j=s.substring(3),F=null;for(var i=0;i<n.length;i++){if(n[i].getId()===this._createId(j)||n[i].getId()===j){F=n[i];break;}}return F;}}return null;};h.prototype._getObject=function(p,o,j){var n=this._oObject,r="";for(var i=0;i<this.aBindings.length;i++){var B=this.aBindings[i],R=this.resolve(B.getPath(),B.getContext());if(R&&!B._bAttached){B._bAttached=true;this._getObject(B.getPath(),B.getContext(),true);}}if(typeof p==="string"&&p.indexOf("/")!=0&&!o){return null;}if(o instanceof M){n=o;r=p;}else if(!o||o instanceof C){r=this.resolve(p,o);if(!r){return n;}if(r.indexOf("/"+g)===0){return J.prototype._getObject.apply(this,[p,o]);}}else{n=o;r=p;}if(!n){return null;}var P=r.split("/"),k=0;if(!P[0]){k++;}var l=null,s=null;while(n!==null&&P[k]){var m=P[k];if(m.indexOf("@")===0){n=this._getSpecialNode(n,m.substring(1),l,s);}else if(n instanceof M){l=n;s=m;var N=n.getMetadata(),t=N.getProperty(m);if(t){if(j===true){this._observePropertyChange(n,t);}else if(j===false){this._unobservePropertyChange(n,t);}n=n[t._sGetter]();}else{var A=N.getAggregation(m)||N.getAllPrivateAggregations()[m];if(A){if(j===true){this._observeAggregationChange(n,A);}else if(j===false){this._unobserveAggregationChange(n,A);}n=n[A._sGetter]?n[A._sGetter]():n.getAggregation(m);}else{if(n&&n[m]&&typeof n[m]==="function"){n=n[m]();}else{n=null;}}}}else if(q.isArray(n)||q.isPlainObject(n)){n=n[m];}else{if(n&&n[m]&&typeof n[m]==="function"){n=n[m]();}else{n=null;}}k++;}return n;};h.prototype.destroy=function(){for(var n in this._mAggregationObjects){var o=this._mAggregationObjects[n];if(o.object.invalidate.fn){o.object.invalidate=o.object.invalidate.fn;}}J.prototype.destroy.apply(this,arguments);};h.prototype.observerChanges=function(o){if(o.type=="aggregation"){if(o.mutation=="insert"){this._oObserver.observe(o.child,{properties:true,aggegations:true});}else{this._oObserver.unobserve(o.child,{properties:true,aggegations:true});}}this.checkUpdate();};return h;});
