/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/core/XMLCompositeMetadata','sap/ui/model/base/ManagedObjectModel','sap/ui/core/util/XMLPreprocessor','sap/ui/model/json/JSONModel','sap/ui/core/Fragment','sap/ui/base/ManagedObject','sap/ui/base/DataType','sap/ui/model/base/XMLNodeAttributesModel'],function(q,C,X,M,a,J,F,b,D,c){"use strict";var m={};function d(s,o){if(!m[s]){q.sap.require(s);m[s]=q.sap.getObject(s);}return m[s];}function p(t,v,n,o){var B=b.bindingParser(v,o,true);if(B&&typeof B==="object"){return B;}var V=v=B||v;var T=D.getType(t);if(T){if(T instanceof D){V=T.parseValue(v);}}else{throw new Error("Property "+n+" has unknown type "+t);}return typeof V==="string"?b.bindingParser.escape(V):V;}function e(j,n,E,I,v){var A=new J(E),o=I.getMetadata(),l=o.getAllAggregations(),P=o.getAllProperties(),s=o._mAllSpecialSettings;A.getVisitor=function(){return v;};A._getObject=function(r,t){var R;r=this.resolve(r,t);r=r.substring(1);var u=r.split("/");if(r&&r.startsWith&&r.startsWith("metadataContexts")){return this._navInMetadataContexts(r);}if(P.hasOwnProperty(r)){var w=P[r];if(!E.hasAttribute(r)){return w.defaultValue;}R=v.getResult(E.getAttribute(r))||E.getAttribute(r);if(R){var S=p(w.type,R,r);if(typeof S==="object"&&S.path){return R;}return S;}return null;}else if(l.hasOwnProperty(u[0])){var x=l[u[0]],y=o.getName(),N=y.slice(0,y.lastIndexOf("."));var z,B=E.getElementsByTagNameNS(N,u[0])[0];if(!B){return null;}if(x.multiple){var G,H=[];for(var i=0;i<B.childNodes.length;i++){G=B.childNodes[i];if(G.nodeType==1){z=new c(G,v,"");H.push(z.getContext("/"));}}R=H;}else{z=new c(B,v,"");R=z.getContext("/");}u.shift();return this._getNode(u,R);}else if(s.hasOwnProperty(r)){var K=s[r];if(!E.hasAttribute(r)){return K.defaultValue||null;}R=v.getResult(E.getAttribute(r));if(K.type){var S=p(K.type,R,r);if(typeof S==="object"&&S.path){return R;}return S;}if(R){return R;}return E.getAttribute(r);}};A._navInMetadataContexts=function(i){var r=i.replace("metadataContexts","");var t=r.split("/"),N=j["metadataContexts"].getObject();t.shift();return this._getNode(t,N);};A._getNode=function(i,N){var r=null,t;while(i.length>0&&N){if(N.getObject){r=N.getObject(i.join("/"));}if(!r){t=i.shift();N=N[t];}else{return r;}}return N;};A.getContextName=function(){return n;};j[n]=A.getContext("/");if(j["metadataContexts"]){j["metadataContexts"].oModel.setProperty("/"+n,j[n]);}}function f(i,v,o,j,s){o.model=o.model||s;var K=o.name||o.model||undefined;if(j[K]){return;}try{i[K]=v.getContext(o.model+">"+o.path);j[K]=i[K];}catch(l){i["_$error"].oModel.setProperty("/"+K,l);}}function g(i,v,s,l,n){if(!s&&!l){return;}var o=s?b.bindingParser(s):{parts:[]};var r=l?b.bindingParser(l):{parts:[]};if(!r.parts){r={parts:[r]};}if(!o.parts){o={parts:[o]};}q.merge(o.parts,r.parts);for(var j=0;j<o.parts.length;j++){f(i,v,o.parts[j],o,n);v=v["with"](i,false);}var t=new J(o);i["metadataContexts"]=t.getContext("/");}function h(P){var s={};s.models=P.oModels||{};s.bindingContexts=P.oBindingContexts||{};return s;}var k=C.extend("sap.ui.core.XMLComposite",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%',invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},displayBlock:{type:"boolean",group:"Appearance",defaultValue:true,invalidate:true}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}}},renderer:function(r,o){r.write("<div");r.writeControlData(o);if(!o.getDisplayBlock()&&(o.getWidth()!=="100%"||o.getHeight()!=="100%")){r.addStyle("display","inline-block");}r.writeClasses();if(o.getHeight()){r.addStyle("height",o.getHeight());}if(o.getWidth()){r.addStyle("width",o.getWidth());}r.writeStyles();r.write(">");var i=o.getAggregation(o.getMetadata().getCompositeAggregationName());if(i){r.renderControl(i);}r.write("</div>");}},X);k.prototype.applySettings=function(){this._bIsInitializing=true;var r=C.prototype.applySettings.apply(this,arguments);this._bIsInitializing=false;return r;};k.prototype.byId=function(i){return sap.ui.getCore().byId(F.createId(this.getId(),i));};k.prototype._getManagedObjectModel=function(){if(!this._oManagedObjectModel){this._oManagedObjectModel=new M(this);}return this._oManagedObjectModel;};k.prototype.getSuppressInvalidateAggregation=function(n,s){var o=this.getMetadata(),A=o.getAggregation(n)||o.getAllPrivateAggregations()[n];if(!A){return true;}s=o._suppressInvalidate(A,s);o._requestFragmentRetemplatingCheck(this,A);return s;};k.prototype.setProperty=function(n,v,s){var o=this.getMetadata(),P=o.getProperty(n);if(!P){return this;}s=this.getMetadata()._suppressInvalidate(P,s);if(C.prototype.getProperty.apply(this,[n])!==v){o._requestFragmentRetemplatingCheck(this,P);}return C.prototype.setProperty.apply(this,[n,v,s]);};k.prototype.bindAggregation=function(n,o){var i=this.getMetadata(),A=i.getAggregation(n)||i.getAllPrivateAggregations()[n],B=C.prototype.getBinding.apply(this,[n]);if(!B||(B&&B.getPath()!==o.path)){i._requestFragmentRetemplatingCheck(this,A);}return C.prototype.bindAggregation.apply(this,[n,o]);};k.prototype.unbindAggregation=function(n){var o=this.getMetadata(),A=o.getAggregation(n)||o.getAllPrivateAggregations()[n];if(this.isBound(n)){o._requestFragmentRetemplatingCheck(this,A,true);}return C.prototype.unbindAggregation.apply(this,[n]);};k.prototype.setAggregation=function(n,o,s){return C.prototype.setAggregation.apply(this,[n,o,this.getSuppressInvalidateAggregation(n,s)]);};k.prototype.addAggregation=function(n,o,s){return C.prototype.addAggregation.apply(this,[n,o,this.getSuppressInvalidateAggregation(n,s)]);};k.prototype.insertAggregation=function(n,o,i,s){return C.prototype.insertAggregation.apply(this,[n,o,i,this.getSuppressInvalidateAggregation(n,s)]);};k.prototype.removeAggregation=function(n,o,s){return C.prototype.removeAggregation.apply(this,[n,o,this.getSuppressInvalidateAggregation(n,s)]);};k.prototype.removeAllAggregation=function(n,s){return C.prototype.removeAllAggregation.apply(this,[n,this.getSuppressInvalidateAggregation(n,s)]);};k.prototype.destroyAggregation=function(n,s){return C.prototype.destroyAggregation.apply(this,[n,this.getSuppressInvalidateAggregation(n,s)]);};k.prototype.updateAggregation=function(n,s){var A=this.getMetadata().getAggregation(n);if(A&&A.type==="TemplateMetadataContext"){this.invalidate();return;}C.prototype.updateAggregation.apply(this,arguments);};k.prototype.setVisible=function(v){this.setProperty("visible",v);if(this.getParent()){this.getParent().invalidate();}return this;};k.prototype._destroyCompositeAggregation=function(){var s=this.getMetadata().getCompositeAggregationName(),o=this.getAggregation(s);if(o){o.destroy();}return this;};k.prototype.updateBindings=function(){if(this._bIsInitializing){return;}var r=C.prototype.updateBindings.apply(this,arguments);for(var n in this.mBindingInfos){var A=this.getMetadata().getAggregation(n);if(A&&A.multiple&&!A._doesNotRequireFactory&&this.isBound(n)&&!this.getBinding(n)){this[A._sDestructor]();}}return r;};k.prototype._setCompositeAggregation=function(N){var s=this.getMetadata().getCompositeAggregationName();this._destroyCompositeAggregation();if(!this._oManagedObjectModel){this._getManagedObjectModel();}if(q.isArray(N)){this.setAggregation(s,null);return;}if(N){N.setModel(this._oManagedObjectModel,"$"+this.alias);N.bindObject("$"+this.alias+">/");}var t=this;this.setAggregation(s,N);var t=this;N._getPropertiesToPropagate=function(){var P=b.prototype._getPropertiesToPropagate.apply(this,arguments),B={},o={},i;for(var n in P.oBindingContexts){var j=P.oBindingContexts[n];if(j){i=j.getModel();if(i instanceof M&&i.getRootObject()instanceof k&&"$"+t.alias!==n){continue;}B[n]=P.oBindingContexts[n];}}for(var n in P.oModels){var i=P.oModels[n];if(i&&i instanceof M&&i.getRootObject()instanceof k&&"$"+t.alias!==n){continue;}o[n]=P.oModels[n];}P.oBindingContexts=B;P.oModels=o;return P;};this.invalidate();};k.prototype._initCompositeSupport=function(s){var o=this.getMetadata(),A=o.getCompositeAggregationName(),i=false;if(s&&A){var n=s[A];if(n&&n.localName==="FragmentDefinition"){this._destroyCompositeAggregation();this._setCompositeAggregation(sap.ui.xmlfragment({sId:this.getId(),fragmentContent:s[A],oController:this}));i=true;}delete s[A];}if(!i){this._destroyCompositeAggregation();this._setCompositeAggregation(sap.ui.xmlfragment({sId:this.getId(),fragmentContent:this.getMetadata()._fragment,oController:this}));}};k.prototype.requestFragmentRetemplating=function(i){if(i){this.fragmentRetemplating();return;}var A=this.getMetadata().getMandatoryAggregations(),B=true;for(var n in A){B=typeof this.getBindingInfo(n)==="object";if(!B){break;}}if(B){this.fragmentRetemplating();}};k.prototype.fragmentRetemplating=function(){var o=this.getMetadata(),i=o.getFragment();if(!i){throw new Error("Fragment "+i.tagName+" not found");}var j=this._getManagedObjectModel();var t=this;j.getContextName=function(){return t.alias;};this.setModel(j,this.alias);this.bindObject(this.alias+">/");j._mSettings=h(this._getPropertiesToPropagate());delete j._mSettings.models["$"+this.alias];delete j._mSettings.bindingContexts["$"+this.alias];this.setModel(null,this.alias);a.process(i.querySelector("*"),{},j._mSettings);var s={};s[o.getCompositeAggregationName()]=i;this._initCompositeSupport(s);};k.initialTemplating=function(E,v,s){var i=d(s),o=new J({}),j={"_$error":o.getContext("/")},l=i.getMetadata(),n=l.getFragment(),r=l._mSpecialSettings.metadataContexts?l._mSpecialSettings.metadataContexts.defaultValue:"";if(!n){throw new Error("Fragment "+s+" not found");}g(j,v,E.getAttribute("metadataContexts"),r,i.prototype.defaultMetaModel);e(j,i.prototype.alias,E,i,v);var t=v["with"](j,true);var u=i.getMetadata();t.visitChildNodes(n);var N=n.ownerDocument.createElementNS("http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1",u.getCompositeAggregationName());N.appendChild(n);E.appendChild(N);};return k;});
