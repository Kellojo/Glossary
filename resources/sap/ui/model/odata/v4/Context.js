/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/SyncPromise","sap/ui/model/Context","./lib/_Helper"],function(S,B,_){"use strict";function c(o){return o&&JSON.parse(JSON.stringify(o));}function f(o,p,e){var E,P=[o.fetchValue(p)],r=o.getPath(p);if(e){P.push(o.oModel.getMetaModel().fetchUI5Type(r));}return S.all(P).then(function(R){var t=R[1],v=R[0];if(v&&typeof v==="object"){E=new Error("Accessed value is not primitive: "+r);E.isNotPrimitive=true;throw E;}return e?t.formatValue(v,"string"):v;});}var C=B.extend("sap.ui.model.odata.v4.Context",{constructor:function(m,b,p,i,o){B.call(this,m,p);this.oBinding=b;this.oCreatePromise=o&&Promise.resolve(o).then(function(){});this.oSyncCreatePromise=o&&S.resolve(o);this.iIndex=i;}}),s="sap.ui.model.odata.v4.Context";C.prototype.checkUpdate=function(){this.oModel.getDependentBindings(this).forEach(function(d){d.checkUpdate();});};C.prototype.created=function(){return this.oCreatePromise;};C.prototype["delete"]=function(g){var t=this;this.oBinding.checkSuspended();if(this.isTransient()){return t.oBinding._delete(g,"n/a",t);}return this.fetchCanonicalPath().then(function(a){return t.oBinding._delete(g,a.slice(1),t);});};C.prototype.deregisterChange=function(p,l){this.oBinding.deregisterChange(p,l,this.iIndex);};C.prototype.destroy=function(){this.oModel.getDependentBindings(this).forEach(function(d){d.setContext(undefined);});this.oBinding=undefined;this.oModel=undefined;B.prototype.destroy.apply(this);};C.prototype.fetchCanonicalPath=function(){return this.oModel.getMetaModel().fetchCanonicalPath(this);};C.prototype.fetchValue=function(p,l,g){if(this.iIndex===-2){return S.resolve();}return this.oBinding.fetchValue(p&&p[0]==="/"?p:_.buildPath(this.sPath,p),l,g);};C.prototype.getBinding=function(){return this.oBinding;};C.prototype.getCanonicalPath=_.createGetMethod("fetchCanonicalPath",true);C.prototype.getGroupId=function(){return this.oBinding.getGroupId();};C.prototype.getIndex=function(){if(this.oBinding.aContexts&&this.oBinding.aContexts[-1]){return this.iIndex+1;}return this.iIndex;};C.prototype.getObject=function(p){var o=this.fetchValue(p);if(!o.isFulfilled()){return undefined;}return c(o.getResult());};C.prototype.getProperty=function(p,e){var E,o=f(this,p,e);if(o.isRejected()){o.caught();E=o.getResult();if(E.isNotPrimitive){throw E;}else{jQuery.sap.log.warning(E.message,p,s);}}return o.isFulfilled()?o.getResult():undefined;};C.prototype.getQueryOptionsForPath=function(p){return this.oBinding.getQueryOptionsForPath(p);};C.prototype.getUpdateGroupId=function(){return this.oBinding.getUpdateGroupId();};C.prototype.hasPendingChanges=function(){return this.oModel.getDependentBindings(this).some(function(d){return d.hasPendingChanges();});};C.prototype.isTransient=function(){return this.oSyncCreatePromise&&this.oSyncCreatePromise.isPending();};C.prototype.refresh=function(g){if(!this.oBinding.refreshSingle){throw new Error("Refresh is only supported for contexts of a list binding");}this.oBinding.refreshSingle(this,g);};C.prototype.requestCanonicalPath=_.createRequestMethod("fetchCanonicalPath");C.prototype.requestObject=function(p){this.oBinding.checkSuspended();return Promise.resolve(this.fetchValue(p)).then(function(r){return c(r);});};C.prototype.requestProperty=function(p,e){this.oBinding.checkSuspended();return Promise.resolve(f(this,p,e));};C.prototype.setIndex=function(i){this.iIndex=i;};C.prototype.toString=function(){var i="";if(this.iIndex!==undefined){i="["+this.iIndex+(this.isTransient()?"|transient":"")+"]";}return this.sPath+i;};C.prototype.withCache=function(p,P){if(this.iIndex===-2){return S.resolve();}return this.oBinding.withCache(p,P[0]==="/"?P:_.buildPath(this.sPath,P));};return{create:function(m,b,p,i,o){if(p[0]!=="/"){throw new Error("Not an absolute path: "+p);}if(p.slice(-1)==="/"){throw new Error("Unsupported trailing slash: "+p);}return new C(m,b,p,i,o);}};},false);
