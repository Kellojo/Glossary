/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/model/PropertyBinding","./lib/_Cache","./ODataBinding"],function(q,S,C,P,_,a){"use strict";var c="sap.ui.model.odata.v4.ODataPropertyBinding",d=S.resolve({}),s={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true};var O=P.extend("sap.ui.model.odata.v4.ODataPropertyBinding",{constructor:function(m,p,o,b){var B;P.call(this,m,p);if(p.slice(-1)==="/"){throw new Error("Invalid path: "+p);}B=this.oModel.buildBindingParameters(b,["$$groupId"]);this.oCheckUpdateCallToken=undefined;this.sGroupId=B.$$groupId;this.mQueryOptions=this.oModel.buildQueryOptions(b,false);this.oCachePromise=S.resolve();this.fetchCache(o);this.oContext=o;this.bInitial=true;this.sPathWithFetchTypeError=undefined;this.vValue=undefined;m.bindingCreated(this);},metadata:{publicMethods:[]}});a(O.prototype);O.prototype.attachEvent=function(e){if(!(e in s)){throw new Error("Unsupported event '"+e+"': v4.ODataPropertyBinding#attachEvent");}return P.prototype.attachEvent.apply(this,arguments);};O.prototype.checkUpdate=function(f,b,g){var o={},e={reason:b||C.Change},D=false,F=false,m=this.oModel.getMetaModel(),p={data:{}},h,i=[],r,R,j=this.oModel.resolve(this.sPath,this.oContext),t=this;this.oCheckUpdateCallToken=o;if(!j){h=Promise.resolve();if(t.vValue!==undefined){h=h.then(function(){t._fireChange(e);});}t.vValue=undefined;return h;}R=m.getMetaPath(j);if(R!==this.sPathWithFetchTypeError&&!this.oType&&this.sInternalType!=="any"){i.push(m.fetchUI5Type(j).then(function(T){t.setType(T,t.sInternalType);})["catch"](function(E){t.sPathWithFetchTypeError=R;q.sap.log.warning(E.message,j,c);}));}r=this.oCachePromise.then(function(k){if(k){g=g||t.getGroupId();return k.fetchValue(g,undefined,function(){D=true;t.fireDataRequested();},t);}if(!t.oContext){return undefined;}if(t.oContext.getIndex()===-2){f=false;}return t.oContext.fetchValue(t.sPath,t,g);});i.push(r.then(function(v){if(v&&typeof v==="object"&&(t.sInternalType!=="any"||t.sPath[t.sPath.lastIndexOf("/")+1]!=="#")){q.sap.log.error("Accessed value is not primitive",j,c);v=undefined;}F=t.vValue!==v;t.vValue=v;})["catch"](function(E){t.oModel.reportError("Failed to read path "+j,c,E);if(!E.canceled){p={error:E};if(t.oCheckUpdateCallToken===o){F=t.vValue!==undefined;t.vValue=undefined;}}return E.canceled;}));return Promise.all(i).then(function(k){var l=k[i.length-1];if(!l){t.bInitial=false;if(f||F){t._fireChange(e);}}if(D){t.fireDataReceived(p);}});};O.prototype.deregisterChange=function(){var t=this;this.withCache(function(o,p){o.deregisterChange(p,t);}).catch(function(e){q.sap.log.error("Error in deregisterChange",e,c);});};O.prototype.destroy=function(){this.deregisterChange();this.oModel.bindingDestroyed(this);this.oCachePromise=undefined;this.oContext=undefined;P.prototype.destroy.apply(this,arguments);};O.prototype.doCreateCache=function(r,Q){return _.createProperty(this.oModel.oRequestor,r,Q);};O.prototype.doFetchQueryOptions=function(){return d;};O.prototype.getUnitOrCurrencyPath=function(){var m=this.oModel.getMetaModel(),r=this.oModel.resolve(this.sPath,this.oContext),A=m.getObject("@",m.getMetaContext(r)),M=A["@Org.OData.Measures.V1.Unit"]||A["@Org.OData.Measures.V1.ISOCurrency"];return M&&M.$Path;};O.prototype.getValue=function(){return this.vValue;};O.prototype.getValueListType=function(){var r=this.getModel().resolve(this.sPath,this.oContext);if(!r){throw new Error(this+" is not resolved yet");}return this.getModel().getMetaModel().getValueListType(r);};O.prototype.onChange=function(v){this.vValue=v;this._fireChange({reason:C.Change});};O.prototype.refreshInternal=function(g,b){this.fetchCache(this.oContext);if(b){this.checkUpdate(true,C.Refresh,g);}};O.prototype.requestValueListInfo=function(){var r=this.getModel().resolve(this.sPath,this.oContext);if(!r){throw new Error(this+" is not resolved yet");}return this.getModel().getMetaModel().requestValueListInfo(r);};O.prototype.requestValueListType=function(){var r=this.getModel().resolve(this.sPath,this.oContext);if(!r){throw new Error(this+" is not resolved yet");}return this.getModel().getMetaModel().requestValueListType(r);};O.prototype.resetInvalidDataState=function(){if(this.getDataState().isControlDirty()){this._fireChange({reason:C.Change});}};O.prototype.resume=function(){throw new Error("Unsupported operation: resume");};O.prototype.resumeInternal=function(b){this.fetchCache(this.oContext);if(b){this.checkUpdate();}};O.prototype.setContext=function(o){if(this.oContext!==o){if(this.bRelative){this.deregisterChange();}this.oContext=o;if(this.bRelative){this.fetchCache(this.oContext);this.checkUpdate(false,C.Context);}}};O.prototype.setType=function(t){var o=this.oType;if(t&&t.getName()==="sap.ui.model.odata.type.DateTimeOffset"){t.setV4();}P.prototype.setType.apply(this,arguments);if(!this.bInitial&&o!==t){this._fireChange({reason:C.Change});}};O.prototype.setValue=function(v,g){var t=this;function r(e){t.oModel.reportError("Failed to update path "+t.oModel.resolve(t.sPath,t.oContext),c,e);return e;}this.checkSuspended();if(typeof v==="function"||(v&&typeof v==="object")){throw r(new Error("Not a primitive value"));}if(this.vValue===undefined){throw r(new Error("Must not change a property before it has been read"));}this.oModel.checkGroupId(g);if(this.vValue!==v){this.oCachePromise.then(function(o){if(o){r(new Error("Cannot set value on this binding"));}else{t.oModel.getMetaModel().fetchUpdateData(t.sPath,t.oContext).then(function(R){return t.withCache(function(o,b,B){return o.update(g||B.getUpdateGroupId(),R.propertyPath,v,r,R.editUrl,b,t.getUnitOrCurrencyPath());},R.entityPath);})["catch"](function(e){if(!e.canceled){r(e);}});}});}};O.prototype.suspend=function(){throw new Error("Unsupported operation: suspend");};O.prototype.toString=function(){return c+": "+(this.bRelative?this.oContext+"|":"")+this.sPath;};return O;});
