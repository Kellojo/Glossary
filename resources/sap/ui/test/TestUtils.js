/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","sap/ui/thirdparty/URI","jquery.sap.script","jquery.sap.sjax"],function(q,C,U){"use strict";var r=/\/\$batch($|\?)/,j="application/json;charset=UTF-8;IEEE754Compatible=true",m={},M="\r\nContent-Type: application/http\r\n"+"Content-Transfer-Encoding: binary\r\n\r\nHTTP/1.1 ",R=q.sap.getUriParameters().get("realOData"),a=/^(GET|DELETE|PATCH|POST) (\S+) HTTP\/1\.1$/,d={},p=R==="true"||R==="proxy",b=p||R==="direct",T,v="DataServiceVersion",V="OData-Version";if(b){document.title=document.title+" (real OData)";}function c(A,e,P){var s=QUnit.objectType(A),E=QUnit.objectType(e),n;if(s!==E){throw new Error(P+": actual type "+s+" does not match expected type "+E);}if(s==="array"){if(A.length<e.length){throw new Error(P+": array length: "+A.length+" < "+e.length);}}if(s==="array"||s==="object"){for(n in e){c(A[n],e[n],P==="/"?P+n:P+"/"+n);}}else if(A!==e){throw new Error(P+": actual value "+A+" does not match expected value "+e);}}function f(A,e,s,E){try{c(A,e,"/");QUnit.assert.pushResult({result:E,actual:A,expected:e,message:s});}catch(g){QUnit.assert.pushResult({result:!E,actual:A,expected:e,message:(s||"")+" failed because of "+g.message});}}T={deepContains:function(A,e,s){f(A,e,s,true);},notDeepContains:function(A,e,s){f(A,e,s,false);},useFakeServer:function(s,B,F){function g(S,E,G){var H=G.requestBody,I,J=[""];I=o(H);H.split(I).slice(1,-1).forEach(function(K){var L,N=G.requestHeaders,O,P,Q;K=K.slice(K.indexOf("\r\n\r\n")+4);O=o(K);L=a.exec(O);if(!L){Q=y(O);}else if(L[1]==="DELETE"){Q="204\r\n"+"Content-Length: 0\r\n"+k(u(N))+"\r\n\r\n";}else if(L[1]==="POST"||L[1]==="PATCH"){Q="200\r\nContent-Type: "+j+"\r\n"+k(u(N))+"\r\n"+w(K);}else{P=E[S+L[2]];if(P){try{Q="200\r\nContent-Type: "+j+"\r\n"+k(u(N,P[1]))+"\r\n"+JSON.stringify(JSON.parse(P[2]))+"\r\n";q.sap.log.info(O,null,"sap.ui.test.TestUtils");}catch(e){Q=h(O,500,"Invalid JSON");}}else{Q=y(O);}}J.push(M+Q);});J.push("--\r\n");A([200,{"Content-Type":"multipart/mixed;boundary="+I.slice(2)},J.join(I)],G);}function h(e,E,G){q.sap.log.error(e,G,"sap.ui.test.TestUtils");return E+"\r\nContent-Type: text/plain\r\n\r\n"+G+"\r\n";}function i(){var H,e,E,G,I={};for(G in F){E=F[G];H=E.headers||{};if(E.source){e=z(B+E.source);H["Content-Type"]=H["Content-Type"]||l(E.source);}else{e=E.message||"";}I[G]=[E.code||200,H,e];}return I;}function k(H){return H&&H.length?H.join(": ")+"\r\n":"";}function l(N){if(/\.xml$/.test(N)){return"application/xml";}if(/\.json$/.test(N)){return j;}return"application/x-octet-stream";}function n(e){A([200,{"Content-Type":j},e.requestBody],e);}function o(e){return e.slice(0,e.indexOf("\r\n"));}function t(H,K){var e;K=K.toLowerCase();for(e in H){if(e.toLowerCase()===K){return H[e];}}}function u(e,E){var O=t(E,V),G=t(E,v),H=[];if(!O&&!G){O=t(e,V);G=t(e,v);}if(O){H.push(V);H.push(O);}else if(G){H.push(v);H.push(G);}return H;}function w(e){return e.slice(e.indexOf("\n\r\n")+3);}function x(e,E){var G=E.url;if(r.test(G)){g(G.slice(0,G.indexOf("/$batch")+1),e,E);}else{n(E);}}function y(e){return h(e,404,"No mock data found");}function z(P){var e=m[P],E;if(!e){E=q.sap.sjax({url:P,dataType:"text"});if(!E.success){throw new Error(P+": resource not found");}m[P]=e=E.data;}return e;}function A(e,E){var G=e[1],H=u({},G);if(H.length===0){H=u(E.requestHeaders);if(H.length>0){G=q.extend({},G);G[H[0]]=H[1];}}E.respond(e[0],G,e[2]);}function D(){var e,S,E=i(),G;S=sinon.fakeServer.create();s.add(S);S.autoRespond=true;for(G in E){S.respondWith("GET",G,A.bind(null,E[G]));}S.respondWith("DELETE",/.*/,A.bind(null,[204,{},""]));S.respondWith("HEAD",/.*/,A.bind(null,[200,{},""]));S.respondWith("PATCH",/.*/,n);S.respondWith("POST",/.*/,x.bind(null,E));e=S.restore;S.restore=function(){sinon.FakeXMLHttpRequest.filters=[];e.apply(this,arguments);};sinon.xhr.supportsCORS=q.support.cors;sinon.FakeXMLHttpRequest.useFilters=true;sinon.FakeXMLHttpRequest.addFilter(function(H,G){return H!=="DELETE"&&H!=="HEAD"&&H!=="PATCH"&&H!=="POST"&&!(H==="GET"&&G in E);});}B=q.sap.getResourcePath(B).replace(/(^|\/)resources\/(~[-a-zA-Z0-9_.]*~\/)?/,"$1test-resources/")+"/";D();},withNormalizedMessages:function(e){var s=sinon.sandbox.create();try{var o=sap.ui.getCore(),g=o.getLibraryResourceBundle;s.stub(o,"getLibraryResourceBundle").returns({getText:function(k,A){var h=k,t=g.call(o).getText(k),i;for(i=0;i<10;i+=1){if(t.indexOf("{"+i+"}")>=0){h+=" "+(i>=A.length?"{"+i+"}":A[i]);}}return h;}});e.apply(this);}finally{s.verifyAndRestore();}},isRealOData:function(){return b;},getRealOData:function(){return R?"&realOData="+R:"";},getBaseUri:function(){var e;if(document.baseURI){return document.baseURI;}e=document.getElementsByTagName("base");return e[0]&&e[0].href||location.href;},proxy:function(A){var P;if(!p){return A;}P=q.sap.getResourcePath("sap/ui").replace("resources/sap/ui","proxy");return new U(P+A,T.getBaseUri()).pathname().toString();},retrieveData:function(k){var e=d[k];delete d[k];return e;},setData:function(k,e){d[k]=e;},setupODataV4Server:function(s,F,S,e){var g={};if(b){return;}if(!e){e="/";}else if(e.slice(-1)!=="/"){e+="/";}Object.keys(F).forEach(function(u){var A=u[0]==="/"?u:e+u;g[A]=F[u];});T.useFakeServer(s,S||"sap/ui/core/qunit/odata/v4/data",g);}};return T;},true);
