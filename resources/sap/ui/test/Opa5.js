/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./Opa','./OpaPlugin','./PageObjectFactory','sap/ui/base/Object','./launchers/iFrameLauncher','./launchers/componentLauncher','sap/ui/core/routing/HashChanger','./matchers/Matcher','./matchers/AggregationFilled','./matchers/PropertyStrictEquals','./pipelines/ActionPipeline','./_ParameterValidator','./_OpaLogger','sap/ui/thirdparty/URI','sap/ui/base/EventProvider','sap/ui/qunit/QUnitUtils','./autowaiter/_autoWaiter'],function($,O,a,P,U,f,c,H,M,A,b,d,_,e,g,E,Q,h){"use strict";var l=e.getLogger("sap.ui.test.Opa5"),p=new a(),o=new d(),F="OpaFrame",v=new _({errorPrefix:"sap.ui.test.Opa5#waitFor"}),C=["visible","viewNamespace","viewName","autoWait"].concat(O._aConfigValuesForWaitFor),i=["check","error","success"].concat(O._aConfigValuesForWaitFor),j=[],k=new E();O._extractAppParams=function(){var B=[/^opa((?!(Frame)).*)$/,/hidepassed/,/noglobals/,/notrycatch/,/coverage/,/module/,/filter/];var w={};var x=new g().search(true);Object.keys(x).forEach(function(y){var z=false;B.forEach(function(D){if(!z&&y.match(D)){l.debug("Skipping uri parameter: "+y+" as blacklisted with pattern: "+D);z=true;}});if(!z){w[y]=O._parseParam(x[y]);}});return w;};var r=function(T,w){for(var K in w){if(T.hasOwnProperty(K)&&w.hasOwnProperty(K)){if(typeof T[K]=="object"&&typeof w[K]=="object"){r(T[K],w[K]);}else{delete T[K];}}}return T;};var m=O._extractAppParams();var n=U.extend("sap.ui.test.Opa5",$.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));function s(){var w=this;var x=arguments.length===1&&$.isPlainObject(arguments[0])?arguments[0]:{source:arguments[0],timeout:arguments[1],autoWait:arguments[2]};if(x.source&&typeof x.source!=="string"){x.source=x.source.toString();}var y=new g(x.source);y.search($.extend(y.search(true),O.config.appParams));var z=u();z.success=function(){q(y.toString());};this.waitFor(z);var B=u();B.check=f.hasLaunched;B.timeout=x.timeout||80;B.errorMessage="unable to load the IFrame with the url: "+x.source;w.waitFor(B);var L=u();L.success=function(){w._loadExtensions(f.getWindow());};this.waitFor(L);var W=u();W.autoWait=x.autoWait||false;W.timeout=x.timeout||80;return this.waitFor(W);}n.prototype.iStartMyUIComponent=function iStartMyUIComponent(w){var x=this;var y=false;w=w||{};var z=u();z.success=function(){var D=new g();D.search($.extend(D.search(true),O.config.appParams));window.history.replaceState({},"",D.toString());};this.waitFor(z);var S=u();S.success=function(){var D=$.sap.getModulePath("sap.ui.test.OpaCss",".css");$.sap.includeStyleSheet(D);H.getInstance().setHash(w.hash||"");c.start(w.componentConfig).then(function(){y=true;});};this.waitFor(S);var B=u();B.errorMessage="Unable to load the component with the name: "+w.name;B.check=function(){return y;};if(w.timeout){B.timeout=w.timeout;}x.waitFor(B);var L=u();L.success=function(){x._loadExtensions(window);};this.waitFor(L);var W=u();W.autoWait=w.autoWait||false;W.timeout=w.timeout||80;return this.waitFor(W);};n.prototype.iTeardownMyUIComponent=function iTeardownMyUIComponent(){var w=u();w.success=function(){c.teardown();};var x=u();x.success=function(){var y=new g();y.search(r(y.search(true),O.config.appParams));window.history.replaceState({},"",y.toString());};return $.when(this.waitFor(w),this.waitFor(x));};n.prototype.iTeardownMyApp=function(){var w=this;var x=u();x.success=function(){w._unloadExtensions(n.getWindow());};var y=u();y.success=function(){if(f.hasLaunched()){this.iTeardownMyAppFrame();}else if(c.hasLaunched()){this.iTeardownMyUIComponent();}else{var z="A teardown was called but there was nothing to tear down use iStartMyComponent or iStartMyAppInAFrame";l.error(z,"Opa");throw new Error(z);}}.bind(this);return $.when(this.waitFor(x),this.waitFor(y));};n.iStartMyAppInAFrame=s;n.prototype.iStartMyAppInAFrame=s;function t(){var w=u();w.success=function(){f.teardown();};return this.waitFor(w);}n.iTeardownMyAppFrame=t;n.prototype.iTeardownMyAppFrame=t;n.prototype.hasAppStartedInAFrame=function(){return f.hasLaunched();};n.prototype.hasUIComponentStarted=function(){return c.hasLaunched();};n.prototype.hasAppStarted=function(){return f.hasLaunched()||c.hasLaunched();};n.prototype.waitFor=function(w){var x=w.actions,y=O._createFilteredConfig(C),z;w=$.extend({},y,w);w.actions=x;v.validate({validationInfo:n._validationInfo,inputToValidate:w});var B=w.check,D=null,G=w.success,R,I;z=O._createFilteredOptions(i,w);z.check=function(){var J=!!w.actions||w.autoWait;var K=n._getAutoWaiter();K.extendConfig(w.autoWait);if(J&&K.hasToWait()){return false;}var p=n.getPlugin();var L=$.extend({},w,{interactable:J});R=p._getFilteredControls(L,D);if(f.hasLaunched()&&$.isArray(R)){var N=[];R.forEach(function(S){N.push(S);});R=N;}if(R===a.FILTER_FOUND_NO_CONTROLS){l.debug("Matchers found no controls so check function will be skipped");return false;}if(B){return this._executeCheck(B,R);}return true;};z.success=function(){var W=O._getWaitForCounter();if(x&&(R||!I)){o.process({actions:x,control:R});}if(!G){return;}var J=[];if(R){J.push(R);}if(W.get()===0){G.apply(this,J);return;}var K=u();if($.isPlainObject(w.autoWait)){K.autoWait=$.extend({},w.autoWait);}else{K.autoWait=w.autoWait;}K.success=function(){G.apply(this,J);};this.waitFor(K);};return O.prototype.waitFor.call(this,z);};n.getPlugin=function(){return f.getPlugin()||p;};n.getJQuery=function(){return f.getJQuery()||$;};n.getWindow=function(){return f.getWindow()||window;};n.getUtils=function(){return f.getUtils()||Q;};n.getHashChanger=function(){return f.getHashChanger()||H.getInstance();};n._getAutoWaiter=function(){return f._getAutoWaiter()||h;};n.extendConfig=function(w){O.extendConfig(w);O.extendConfig({appParams:m});n._getAutoWaiter().extendConfig(w.autoWait);};n.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new n(),actions:new n(),assertions:new n(),visible:true,autoWait:false,_stackDropCount:1});O.extendConfig({appParams:m});};n.getTestLibConfig=function(T){return O.config.testLibs&&O.config.testLibs[T]?O.config.testLibs[T]:{};};n.emptyQueue=O.emptyQueue;n.stopQueue=O.stopQueue;n.getContext=O.getContext;n.matchers={};n.matchers.Matcher=M;n.matchers.AggregationFilled=A;n.matchers.PropertyStrictEquals=b;n.createPageObjects=function(w){return P.create(w,n);};n.prototype._executeCheck=function(w,x){var y=[];x&&y.push(x);l.debug("Executing OPA check function on controls "+x);l.debug("Check function is:\n"+w);var R=w.apply(this,y);l.debug("Result of check function is: "+R||"not defined or null");return R;};n.resetConfig();function q(S){var I=$.sap.getModulePath("sap.ui.test.OpaCss",".css");$.sap.includeStyleSheet(I);return f.launch({frameId:F,source:S,opaLogLevel:O.config.logLevel});}function u(){return{viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};}$(function(){if($("#"+F).length){q();}$("body").addClass("sapUiBody");$("html").height("100%");});n._validationInfo=$.extend({_stack:"string",viewName:"string",viewNamespace:"string",visible:"bool",matchers:"any",actions:"any",id:"any",controlType:"any",searchOpenDialogs:"bool",autoWait:"any"},O._validationInfo);n._getEventProvider=function(){return k;};n.prototype._loadExtensions=function(w){var x=this;var y=O.config.extensions?O.config.extensions:[];var z=$.when($.map(y,function(B){var D;var G=$.Deferred();w.sap.ui.require([B],function(I){D=new I();D.name=B;x._executeExtensionOnAfterInit(D,w).done(function(){n._getEventProvider().fireEvent('onExtensionAfterInit',{extension:D,appWindow:w});x._addExtension(D);G.resolve();}).fail(function(J){l.error(new Error("Error during extension init: "+J),"Opa");G.resolve();});});return G.promise();}));return this._schedulePromiseOnFlow(z);};n.prototype._unloadExtensions=function(w){var x=this;var y=$.when($.map(this._getExtensions(),function(z){var B=$.Deferred();n._getEventProvider().fireEvent('onExtensionBeforeExit',{extension:z});x._executeExtensionOnBeforeExit(z,w).done(function(){B.resolve();}).fail(function(D){l.error(new Error("Error during extension init: "+D),"Opa");B.resolve();});return B.promise();}));this._schedulePromiseOnFlow(y);};n.prototype._addExtension=function(w){j.push(w);};n.prototype._getExtensions=function(){return j;};n.prototype._executeExtensionOnAfterInit=function(w,x){var D=$.Deferred();var y=w.onAfterInit;if(y){y.bind(x)().done(function(){D.resolve();}).fail(function(z){D.reject(new Error("Error while waiting for extension: "+w.name+" to init, details: "+z));});}else{D.resolve();}return D.promise();};n.prototype._executeExtensionOnBeforeExit=function(w,x){var D=$.Deferred();var y=w.onBeforeExit;if(y){y.bind(x)().done(function(){D.resolve();}).fail(function(z){D.reject(new Error("Error while waiting for extension: "+w.name+" to exit, details: "+z));});}else{D.resolve();}return D.promise();};return n;});
